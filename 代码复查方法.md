# 代码复查方法

## IDE配置

开发所使用的代码编辑器应作同一配置，包含：
- 代码质量审查插件，如**SonarLint**，FindBugs，CheckStyle
- 配置统一标准（或合理）的JavaDoc模板
- Tab键设置为4空格
- 代码格式化不自动调整属性和方法顺序，代码提交前使用格式化你的代码并除去未使用的import和类注入

## 静态代码检查

除了使用IDE插件在编码阶段做静态代码检查以外，也可以通过在**CI/CD**中集成代码检查，在合并分支时自动运行。静态代码检查问题应该在复查人或经理推动下持续改进。

## 人工代码复查

人工代码复查不需要过分关注自动检查工具可以检查的部分，而应该将关注点转移到**逻辑问题**、**设计问题**、**常见的典型问题**上。人工代码审查的时机为开发者向主要分支提出合并请求时合并代码时、代码评审会准备期。主要分支必须设置分支保护，仅有负责人能够在代码审查后合并分支。为避免一次分支合并审查代码内容过于繁杂，应该合理限制单次合并功能点大小及数量，例如：将一个feature规划中的大功能按步骤拆解为多个小功能，每完成一个小功能及时提交合并请求。

### 公司规范复查

公司已有的技术规范或设计、开发方面的约束，在项目设计中可能不会赘述，但是审查时也应注意开发者对这方面规范的执行情况。

### 对可复用内容使用的审查

对于一些已有的工具类库、组件（包括语言本身提供以及公司自研），其中常常对推荐的使用方式做了良好封装，不仅可以直接使用最佳实践而且可以避免重复劳动，另外增强产品代码一致性。即使已经实现功能，也应该通过代码审查告知开发者有可复用工具。

### 安全问题复查

具有安全性要求的服务、和其他公司对接的服务、涉及隐私或者其他保密信息的服务、提供公网访问的服务，还需要对数据字段加密设计、文件存储加密设计、接口参数校验、权限校验、异常原生返回等方面做检查。

### pull request

建议注释包含以下涉及内容：

- 修改类型说明
> - [ ] 修复缺陷(不改变原有功能并修复了bug)。
> - [ ] 新特性 (不改变原有功能并增加了新特性)。
> - [ ] 不向下兼容 (修复bug或增加新特性，但是破坏了旧版本接口)。

- 修改功能说明

- 检查清单
> - [ ] 已修改sonarlint问题
> - [ ] 需要同步修改文档
> - [ ] 已修改了相应的文档
> - [ ] 已通过了单元测试
> - [ ] 代码中无硬编码

## 持续跟踪并总结代码审查常见问题

### 重点关注典型问题

典型问题值基于公司业务场景和类型总结出来的容易出现的代码问题，复查的时候应该有针对性的查找这方面问题

> - 在循环中做查询或者重复装载同一对象
> - 大文件处理一次读入过多数据造成内存溢出
> - 事务是否被合理的使用
> - 支持集群部署的服务功能对于锁的合理使用
> - 异常捕获后，是否明确记录了日志以及向上层抛出
> - ……

### 类设计复查

> - 类的实现是否符合单一职责原则，重点关注超过500行代码的实现类
> - 类是否符合里氏代换原则，重点关注不常见的类继承方式
> - 关注代码的依赖是否需要遵循依赖倒置原则（根据业务需求是否会频繁变化作为判断依据）
> - 关注代码的时候是否符合迪米特法则，重点关注多个类之间是否有互相依赖的情况
> - 尽量使用合成的方式，而不是继承
> - 业务类之间应该避免直接依赖对方类中定义的数据结构
> - 是否可以使用设计模式以及已用的设计模式是否合理不冗余

### 线程安全问题

> - 缓存类的init，reload，get方法间的并发可能性
> - 定时任务并发的可能性
> - 线程是否被合理的创建，关注出现new Thread、Executors的地方
> - 锁的合理使用
> - 在多线程中使用非线程安全的数据结构
> - run中对Bean属性赋值，却在主线程中直接取值
> - ……

### SQL的编写

> - 超长SQL
> - 没有做预查询的大表关联
> - 索引的使用

### redis使用

> - 没有使用连接池而是在使用时直接新建和关闭连接
> - 一次从redis上下载大量数据到内存
> - 在循环中操作redis

### 流操作

> - 关注正常、异常情况下流是否能正常关闭
> - 流是否被及时关闭，尤其是频繁IO处理的服务

### 异常处理

> - 接口是否向前台提供了明确易理解的异常说明
> - 应该对外提供的异常说明是否对应服务的异常码表
> - 支持国际化的项目中，添加异常码是否也向资源文件中添加了各语言的异常描述信息

### 日志记录

> - 合理使用error、warn、info、debug日志级别
> - 日志的输出是否可以支撑问题排查和生成环境调试需求，需要输出的信息是否完整输出